// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

// cuid -> collision-resistant unique ID
generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// Entities
model Department {
  id   String @id @default(cuid())
  name String @unique
  // code String? @unique
  // description String?
  // I don't think image/logo of department is necessary if in case we need then
  // image String? 

  // Relations
  branches  Branch[]
  teachers  Teacher[]
  hod       Teacher?  @relation("Department_HOD", fields: [hodId], references: [id])
  hodId     String?   @unique
  dhod      Teacher?  @relation("Department_DHOD", fields: [dhodId], references: [id])
  dhodId    String?   @unique
  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@map("departments")
}

model Branch {
  id           String @id @default(cuid())
  name         String
  code         String @unique
  departmentId String
  // description String?
  // image String?

  // Relations

  department Department @relation(fields: [departmentId], references: [id])
  semesters  Semester[]
  students   Student[]
  subjects   Subject[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([departmentId, name])
  @@map("branches")
}

model Semester {
  id     String  @id @default(cuid())
  number Int
  name   String?

  //Relation 
  branch    Branch    @relation(fields: [branchId], references: [id])
  branchId  String
  subjects  Subject[]
  students  Student[] @relation("Student_CurrentSemester")
  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@unique([branchId, number])
  @@map("semesters")
}

model Subject {
  id      String  @id @default(cuid())
  name    String
  code    String  @unique
  isLab   Boolean @default(false)
  credits Int?
  // image String?

  // Relations
  branch     Branch          @relation(fields: [branchId], references: [id])
  branchId   String
  semester   Semester        @relation(fields: [semesterId], references: [id])
  semesterId String
  teacher    Teacher         @relation(fields: [teacherId], references: [id])
  teacherId  String
  sessions   ClassSessions[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([branchId, semesterId, code])
  @@map("subjects")
}

model ClassSessions {
  id        String   @id @default(cuid())
  date      DateTime // Date of the session
  startTime DateTime // Start time (with date)
  endTime   DateTime // End time (with date)
  topic     String?

  // Relations
  subject    Subject            @relation(fields: [subjectId], references: [id])
  subjectId  String
  teacher    Teacher            @relation(fields: [teacherId], references: [id])
  teacherId  String
  attendance AttendanceRecord[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([subjectId, date])
  @@map("class_sessions")
}

// Base User model for common fields
model User {
  id                String    @id @default(cuid())
  email             String    @unique
  phone             String    @unique
  passwordHash      String
  isActive          Boolean   @default(true)
  isEmailVerified   Boolean   @default(false)
  isPhoneVerified   Boolean?  @default(false)
  isProfileComplete Boolean   @default(false)
  lastLogin         DateTime?
  role              UserRole  @default(STUDENT)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations to specific user types
  student                 Student?
  teacher                 Teacher?
  crew                    Crew?
  emailVerificationTokens EmailVerificationToken[]

  @@index([email, role])
  @@map("users")
}

enum UserRole {
  STUDENT
  TEACHER
  HOD
  DHOD
  CAMPUS_CHIEF
  VICE_CAMPUS_CHIEF
  CREW
  SUPER_ADMIN
}

model Student {
  id               String    @id @default(cuid())
  rollNo           String    @unique
  firstName        String
  middleName       String?
  lastName         String
  dob              DateTime? // Date of birth
  gender           String? // M, F, O
  // address          String?
  emergencyContact String?

  // Image field (also in User model, but specific to student if needed)
  // The main image will be in User model

  // Relations
  user              User               @relation(fields: [userId], references: [id])
  userId            String             @unique
  branch            Branch             @relation(fields: [branchId], references: [id])
  branchId          String
  currentSemester   Semester?          @relation("Student_CurrentSemester", fields: [currentSemesterId], references: [id])
  currentSemesterId String?
  attendanceRecords AttendanceRecord[]

  // RFID & Biometric
  rfidTagId       String? @unique
  fingerprintHash String? // Hashed fingerprint template

  // Academic
  academicYear String? // e.g., "2023-2024"
  batch        String? // e.g., "2023 Batch"

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([branchId, currentSemesterId])
  @@index([rollNo])
  @@map("students")
}

model Teacher {
  id             String  @id @default(cuid())
  employeeId     String  @unique
  firstName      String
  middleName     String?
  lastName       String
  designation    String // Lecturer, Assistant Professor, Professor, etc.
  // qualification  String? // Ph.D., M.Tech, etc.
  specialization String?

  // Relations
  user         User            @relation(fields: [userId], references: [id])
  userId       String          @unique
  department   Department      @relation(fields: [departmentId], references: [id])
  departmentId String
  subjects     Subject[]
  sessions     ClassSessions[]

  // Admin roles
  isHod             Boolean @default(false)
  isDhod            Boolean @default(false)
  isCampusChief     Boolean @default(false)
  isViceCampusChief Boolean @default(false)

  // Teaching schedule
  officeHours String?
  roomNumber  String?

  // Timestamps
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  // Relations for department head roles (opposite side of Department.hod / Department.dhod)
  hodOf     Department? @relation("Department_HOD")
  dhodOf    Department? @relation("Department_DHOD")

  @@index([employeeId, departmentId])
  @@map("teachers")
}

model Crew {
  id         String  @id @default(cuid())
  employeeId String  @unique
  firstName  String
  middleName String?
  lastName   String
  department String // Exam, Logistics, Library, Administration, etc.
  position   String // Clerk, Librarian, Accountant, etc.

  // Relations
  user   User   @relation(fields: [userId], references: [id])
  userId String @unique

  // Permissions
  permissions Json? // Specific permissions for non-teaching staff

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([employeeId, department])
  @@map("crew")
}

model AttendanceRecord {
  id String @id @default(cuid())

  // Relations
  student   Student       @relation(fields: [studentId], references: [id])
  studentId String
  session   ClassSessions @relation(fields: [sessionId], references: [id])
  sessionId String

  // Attendance data
  scanTime    DateTime // Actual time of scan
  arrivalTime DateTime? // Calculated arrival time (could be same as scanTime)
  score       Float            @default(0.0) // 1.0, 0.8, 0.6, 0.0
  status      AttendanceStatus @default(ABSENT)
  markedBy    MarkedBy         @default(RFID) // How attendance was marked
  notes       String? // Optional notes for manual adjustments

  // Device info
  deviceId   String? // ESP32 device ID
  deviceType String? // "rfid_reader", "fingerprint_scanner"
  ipAddress  String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Auditor info (if manually adjusted)
  adjustedBy       String? // User ID who adjusted the record
  adjustmentReason String? // Reason for adjustment

  @@unique([studentId, sessionId])
  @@index([studentId, createdAt])
  @@index([sessionId])
  @@index([status, scanTime])
  @@map("attendance_records")
}

enum AttendanceStatus {
  PRESENT
  LATE
  VERY_LATE
  ABSENT
  EXCUSED
  HOLIDAY
}

enum MarkedBy {
  RFID
  FINGERPRINT
  MANUAL_SYSTEM
}

// For system logs and audit trails
model SystemLog {
  id         String    @id @default(cuid())
  action     String // e.g., "attendance_marked", "session_created", "image_uploaded"
  entityType String? // e.g., "Student", "Teacher", "AttendanceRecord"
  entityId   String?
  userId     String?
  userType   UserRole?
  details    Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime  @default(now())

  @@index([action, createdAt])
  @@index([userId, userType])
  @@map("system_logs")
}

// For notifications (optional extension)
model Notification {
  id         String           @id @default(cuid())
  userId     String
  userType   UserRole
  title      String
  message    String
  type       NotificationType
  isRead     Boolean          @default(false)
  isArchived Boolean          @default(false)
  metadata   Json?
  link       String? // URL for action
  createdAt  DateTime         @default(now())
  readAt     DateTime?

  @@index([userId, userType, isRead])
  @@index([createdAt])
  @@map("notifications")
}

enum NotificationType {
  ATTENDANCE
  SYSTEM
  ALERT
  REMINDER
  ANNOUNCEMENT
}

// Image metadata for tracking Cloudinary uploads
model ImageAsset {
  id       String @id @default(cuid())
  publicId String @unique // Cloudinary public_id
  url      String @unique // Cloudinary URL
  format   String // "jpg", "png", etc.
  bytes    Int // File size
  width    Int?
  height   Int?

  // Relations
  userId     String? // Associated user
  entityType String? // "student", "teacher", "crew", "department", etc.
  entityId   String? // ID of the entity

  // Timestamps
  uploadedAt DateTime @default(now())

  @@index([userId, entityType])
  @@index([publicId])
  @@map("image_assets")
}

model EmailVerificationToken {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  otp       String // e.g. "123456"
  expiresAt DateTime
  used      Boolean  @default(false)

  createdAt DateTime @default(now())

  @@index([userId, otp])
  @@map("email_verification_tokens")
}
